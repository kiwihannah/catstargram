<!DOCTYPE html>
<html lang="en">

<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
    integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"
    integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ=="
    crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

<head></head>
<script>
    let page = 0;
    $(document).ready(function () {
        $("#user_id").append(localStorage.getItem("user_id"));
        let post_no = localStorage.getItem("post_no");
        if (Number(post_no)) read_one(post_no);
        read_cmt(post_no);
    });

    function read_one(post_no) {
        $("#post").empty(); let temp_html = ``;
        $.ajax({
            type: "GET",
            url: `/api/posts/one/${post_no}`,
            success: function (response) {
                let post = response["post"]; let isReadonly = "", isDisabled = "";
                if (post["user_id"] === localStorage.getItem("user_id")) {
                    isReadonly = ""
                } else {
                    isReadonly = "readonly"; post_no = 0; isDisabled = "disabled";
                }
                temp_html = `<div class="form-group">
                                <label for="email">제목</label>
                                <input type="text" class="form-control" id="title" value="${post["title"]}" ${isReadonly}>
                            </div>
                            <div class="form-group">
                                <label for="message">내용</label>
                                <textarea name="message" class="form-control" id="context" rows="5" ${isReadonly}>${post["context"]}</textarea>
                            </div>
                            <button type="submit" class="btn btn-danger float-right ${isDisabled}" onclick="delete_post(${post_no})">삭제</button>
                            <button type="submit" class="btn btn-primary float-right ${isDisabled}" onclick="modify_post(${post_no})">수정</button>`;
                $("#post").append(temp_html);
            },
        });
    }

    function new_post() {
        let user_id = localStorage.getItem("user_id");
        let title = $("#title").val();
        let context = $("#context").val();
        $.ajax({
            type: "POST",
            url: "/api/posts",
            data: { user_id, title, context },
            success: function (response) { alert("저장되었습니다."); window.location.href = "./board.html"; },
        });
    }

    function delete_post(post_no) {
        if (post_no === 0) { alert("본인 게시글만 수정 삭제 할 수 있습니다."); return; }
        $.ajax({
            type: "DELETE",
            url: `/api/posts/${post_no}`,
            success: function (response) { alert("삭제되었습니다."); location.href = "/board.html"; }
        });
    }

    function modify_post(post_no) {
        if (post_no === 0) { alert("본인 게시글만 수정 삭제 할 수 있습니다."); return; }
        let title = $("#title").val();
        let context = $("#context").val();
        $.ajax({
            type: "PUT",
            url: `/api/posts/one/${post_no}`,
            data: { title, context },
            success: function (response) { alert("수정되었습니다."); location.href = "/board.html"; }
        });
    }

    function new_cmt() {
        let post_no = localStorage.getItem("post_no");
        let user_id = localStorage.getItem("user_id");
        let cmt = $("#new-cmt").val();
        $.ajax({
            type: "POST",
            url: "/api/replies",
            data: { post_no, user_id, cmt },
            success: function (response) { alert("저장되었습니다."); window.location.reload(); },
        });
    }

    function read_cmt(post_no) {
        $.ajax({
            type: "GET",
            url: `/api/replies/${post_no}`,
            success: function (response) {
                let replies = response["replies"];
                console.log(replies);
                if (replies.length === 0) $("#alert-cmt").append("아직 댓글이 없습니다.")
                for (let i = 0; i < replies.length; i++) {
                    get_cmt(replies[i]);
                }
            },
        });
    }

    function get_cmt(replies) {
        let isReadonly = "", isDisabled = ""; let cmt_no = 0;
        if (replies["user_id"] === localStorage.getItem("user_id")) {
            isReadonly = ""; cmt_no = replies["cmt_no"];
        } else {
            isReadonly = "readonly"; isDisabled = "disabled"; cmt_no = 0;
        }
        let temp_html = `<tr>
                            <td style="width: 10%;">${replies["user_id"]}</td>
                            <td style="width: 50%;">${replies["cmt"]}</td>
                            <td style="width: 20%;">${replies["ins_date"]}</td>
                            <td style="width: 20%;">
                                <button class="btn btn-danger float-right ${isDisabled}" onclick="delete_cmt('${cmt_no}')">삭제</button>
                                <button class="btn btn-primary float-right ${isDisabled}" onclick="before_modify('${cmt_no}', '${replies["cmt"]}')">수정</button>
                            </td>
                        </tr>`;
        $("#cmt-table").append(temp_html);
    }

    function before_modify(cmt_no,cmt) {
        if (Number(cmt_no) === 0) { alert("본인 댓글만 수정 삭제 할 수 있습니다."); return; }
        $("#cmt-box").empty(); $("#modi-cmt").focus();
        let temp_html = `<td>내 댓글 수정하기</td>
                        <td colspan="4"><input type="text" class="form-control" id="modi-cmt" value="${cmt}"></td>
                        <td><button class="btn btn-primary" onclick="modify_cmt('${cmt_no}')">수정</button></td>`;
        $("#cmt-box").append(temp_html);
    }

    function modify_cmt(cmt_no) {
        let cmt = $("#modi-cmt").val(); let post_no = localStorage.getItem("post_no");
        $.ajax({
            type: "PUT", url: `/api/replies/one/${cmt_no}`, data: { cmt },
            success: function (response) { alert("수정되었습니다."); location.reload(); }
        });
    }

    function delete_cmt(cmt_no) {
        if (Number(cmt_no) === 0) { alert("본인 게시글만 수정 삭제 할 수 있습니다."); return; }
        $.ajax({
            type: "DELETE", url: `/api/replies/one/${cmt_no}`,
            success: function (response) { alert("삭제되었습니다."); location.reload(); }
        });
    }

    function pagination(currentPage, maxPage) {
        $("#page_nav").empty(); $("#list").empty();
        let prevClass = "", nextClass = "";
        if (currentPage === 1) prevClass = "disabled";
        if (currentPage === maxPage) nextClass = "disabled";
        let temp_html = `<li class="page-item"><a class="page-link prevClass" onclick="read_all('${currentPage-1}')">전</a></li>
                        <li class="page-item"><a class="page-link">${currentPage}</a></li>
                        <li class="page-item"><a class="page-link nextClass" onclick="read_all('${currentPage+1}'>후</a></li>`;
        $("#page_nav").append(temp_html);
    }
</script>

<body>
    <div class="jumbotron" style="text-align: center;">
        <h1 class="display-4">HeloOo worRrLd</h1>
        <hr class="my-4">
        <button onclick="logout()" class="btn btn-outline-warning">로그아웃</button>
        <button onclick="getSelf()" class="btn btn-outline-secondary">dev_test</button>
        <button onclick="location.href='register.html'" class="btn btn-outline-success">로그인</button>
    </div>

    <div class="container">
        <h3 style="text-align: center;" id="user_id">안녕하세요, </h3>
        <div id="post">
            <div class="form-group">
                <label for="email">제목</label>
                <input type="text" class="form-control" id="title" placeholder="제목입력" value="">
            </div>
            <div class="form-group">
                <label for="message">내용</label>
                <textarea name="message" class="form-control" id="context" rows="5" placeholder="내용입력" value=""></textarea>
            </div>
            <button type="submit" class="btn btn-primary float-right" onclick="new_post()">저장</button>
        </div>
        <button type="submit" class="btn btn-primary float-left" onclick="location.href='./board.html'">목록으로</button>
    </div>

    <div class="container" style="padding: 30px;">
        <table class="table">
            <tr><th></th><th></th><th></th><th></th></tr>
            <tr style="background-color: honeydew;" id="cmt-box">
                <td>새 댓글 작성하기</td> <p id="alert-cmt"></p>
                <td colspan="4"><input type="text" class="form-control" id="new-cmt"></td>
                <td><button class="btn btn-primary" onclick="new_cmt()">작성</button></td>
            </tr>
        </table>
        <table class="table" id="cmt-table">
        </table>
        <nav style="text-align: center;">
            <ul class="pagination" id="page_nav">
            </ul>
        </nav>
    </div>

</body>

</html>